## seata

概念：

1+3 概念

一个全局事务xid

3个角色

TC  全局事务管理器   可以理解为seata 服务端

TM 驱动事务提交或者回滚		事物的发起方 @glabTrancational

RM 分支事务 可以理解为数据库   单个数据库



使用

@globeTransacation 



seata 的两个阶段的流程：



第一阶段：

1.解析sql信息，拿到sql的类型（update）、表（product）、条件等相关信息  

2.查询当前数据的前镜像信息，就是更新前信息

3.执行我们的业务sql

4.查看后镜像信息，也就是更新后的数据信息

5.插入回滚日志到undo.log表中，数据就是有前镜像跟后镜像的组成

6.提交前，向 TC 注册分支：申请 `product` 表中，主键值等于 1 的记录的 **全局锁**

7.本地事务提交：业务数据的更新和前面步骤中生成的 UNDO LOG 一并提交

8.将本地事务提交的结果上报给 TC

第二阶段：

分会两类：

回滚：

1.收到 TC 的分支回滚请求，开启一个本地事务

2.根据全局事物xid和本地的事物Brand_id查询undo log 表中记录

3.拿undo log 表中的数据跟当前数据对比，如果不同说明当前的数据被别的全局事物id所用到，这就需要根据车略就走

4.根据undo log 的前镜像的数据进行回滚

提交：

1.收到 TC 的分支提交请求，把请求放到一个异步队列中并且马上吧返回值给到Tc

2.异步任务这个提交的阶段，异步批量删除undo log 表中对应的记录

sh startup.sh -m standalone  单机启动

